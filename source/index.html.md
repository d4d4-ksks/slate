---
title: Metaship APIv1

language_tabs: # must be one of https://git.io/vQNgJ
  - php

toc_footers:
  - <a href='https://metaship.ru'>Узнать больше о продукте</a>
  - <a href='https://cabinet.metaship.ru'>Перейти в личный кабинет</a>
  - <a href='https://github.com/metaship-ru/metaship-php-sdk'>PHP SDK</a>
  - <a href='https://github.com/metaship-ru/metaship-java-sdk'>Java SDK</a>
  - <a href='mailto:support@metaship.ru'>Обратиться в поддержку</a>

includes:
  - errors

search: false
---

# Глоссарий

Термин, сокращение | Определение
-------------- | -------------- 
Авторизационные данные | Токен и секретный код, используемые для авторизации в API
АПП | Акт приёма-передачи
ВГХ | Весогабаритные характеристики
ИМ | Интернет-магазин
Клиент | ИМ, осуществляющий взаимодействие с Сервисом, включая его сервисы и информационные системы
ЛК | [Личный кабинет Сервиса](https://cabinet.metaship.ru)
ПВЗ | Пункт выдачи заказов
СД | Служба(ы) доставки
Сервис | MetaShip
API | Программный интерфейс Сервиса, позволяющий в автоматическом режиме обмениваться информацией между информационными системами ИМ и Сервисом

# О сервисе

Сервис MetaShip является интегратором и агрегатором служб доставки. Сервис обеспечивает полный спектр операций по доставке заказа от ИМ до покупателя различными службами доставки через Web-интерфейс и API.

**Цель Сервиса** - повысить эффективность процесса доставки заказов от ИМ к покупателю за счёт:

1. Максимально быстрого и эффективного переключения отправления заказов между службами доставки.
1. Предоставления более выгодных условий обслуживания в сравнении с ситуацией, когда ИМ интегрируется с СД напрямую.
1. Упрощения процесса документооборота.
1. Предоставления дополнительных сопутствующих услуг.

Благодаря использованию Сервиса достигаются следующие **эффекты:**

1. Рост продаж в количественном и денежном выражении.
1. Снижение рисков, связанных с доставкой заказов до покупателя.
1. Оптимизация логистики по ключевым параметрам: скорость, выкуп, качество.
1. Сокращение логистических издержек.
1. Повышение прозрачности отчётности в части взаиморасчётов с СД.
1. Повышение лояльности покупателей.

**Возможности Сервиса:**

1. Единая интеграция с множеством СД, среди которых: Почта России, СДЭК, Boxberry, TopDelivery и др.
1. Печать бланков и сопроводительных документов.
1. Трекинг (отслеживание изменений статусов) отправленных заказов в унифицированном формате, не зависящем от СД.
1. Единый тарификатор, обеспечивающий отображение возможных вариантов доставки в зависимости от параметров заказа.
1. Автоматический расчёт ключевых характеристик доставки (сроки доставки, срок перевода платежей, % выкупа и тд.).
1. Автоматический выбор оптимальных вариантов доставки по заданным условиям.
1. Сверки с СД по актам оказанных услуг и переводу наложенных платежей.
1. Глубокий анализ процесса логистики посредством аналитического модуля, поставляемого как часть Сервиса.

# Начало работы

## Регистрация

Для того, чтобы начать использовать API Сервиса, необходимо получить Авторизационные данные. Для их получения выполните следующую инструкцию:

1. Зарегистрируйтесь в Сервисе:
  1. Зайдите в ЛК.
  1. Нажмите «Получить доступ».
  1. Заполните все поля появившейся формы.
  1. Нажмите «Получить доступ».
  1. Далее следуйте подсказкам на экране.
1. Примите оферту:
  1. Войдите в личный кабинет.
  1. Откройте пункт меню «API».
  1. Выполните инструкцию по принятию оферты.

В результате мы сформируем для вас Авторизационные данные. О том, что Авторизационные данные сформированы, мы уведомим вас по телефону или e-mail, которые были указаны при регистрации. Т.к. процесс валидации учётной записи и формирования Авторизационных данных для неё может занять некоторое время, мы обеспечили возможность тестирования интеграции с сервисом до завершения валидации учётной записи, см. Тестирование интеграции.

## Регламент взаимодействия

Взаимодействие (синхронное) происходит по протоколу API посредством вызова методов веб-сервиса:

1. Endpoint: https://api.metaship.ru/v1/
1. По протоколу HTTPS одним из доступных методов: GET, POST, PUT, DELETE.
1. Кодировка запросов и ответов: UTF-8.
1. Тип контента: application/json.

Описание процесса взаимодействия:

1. Клиент вызывает один из доступных методов Сервиса:
  1. Действия с заказами:
      1. POST /v1/orders
      1. GET /v1/orders/{id}
      1. PUT /v1/orders/{id}
      1. DELETE /v1/orders/{id}
      1. GET /v1/orders/{id}/labels
      1. GET /v1/orders/{id}/statuses
  1. Действия с офферами: GET /v1/offers
  1. Действия с партиями:
      1. POST /v1/parcels
      1. GET /v1/parcels/{id}/acceptance
  1. Прочие действия:
      1. GET /v1/pickuppoints
      1. GET /v1/deliveries
      1. GET /v1/services
      1. GET /v1/statuses
      1. GET /v1/vats
      1. GET /v1/shops
      1. GET /v1/warehouses
1. Сервис осуществляет авторизацию Клиента и валидацию запроса, после чего осуществляет обработку запроса.
1. Сервис синхронно отвечает Клиенту.

<aside class="notice">
В описании API приводится существенно больше методов. Просим игнорировать их наличие, т.к. они добавлены для целей обратной совместимости или созданы под конкретные задачи и клиентов
</aside>


Каждый вызов Сервиса сопровождается передачей значений параметров в заголовке запроса:

1. ContentType: application/json.
1. Authorization: подпись запроса, сформированная по алгоритму.

## Подпись запроса

Подпись запроса необходима для обеспечения безопасности операций, выполняемых посредством API. При формировании подписи запроса используются:

1. Тело запроса.
1. Метод запроса.
1. URL-кодированная строка запроса.
1. Текущие дата и время.
1. Авторизационные данные. Для их получения следуйте инструкции.

### Описание алгоритма

Подпись запроса формируется по алгоритму:

1. В одну строку с пробелом в качестве разделителя объединяются следующие значения (порядок имеет значение):
  1. Метод запроса.
  1. slug запроса.
  1. URL-кодированная строка запроса декодируется. Если строка отсутствует, то на этом этапе формируется пустая строка.
  1. Текущие дата и время преобразуются в строку в формате «Y-m-d\TH:i:s». Пример: 2020-05-12T13:38:44.
1. По алгоритму sha256 вычисляется hash-сумма от тела запроса.
1. По алгоритму sha256 вычисляется hash-сумма от строки, полученной на предыдущем этапе.
1. На основе ключа вычисляется hash-сумма по алгоритму sha256 от строки, полученной на предыдущем этапе. В качестве ключа используется секретный код, полученный на 1. этапе регистрации.
1. В одну строку с запятой и пробелом («, ») в качестве разделителя объединяются следующие значения (порядок имеет значение):
  1. Константа: «HMAC-SHA256».
  1. Строка, полученная на шаге 1d настоящего алгоритма.
  1. Токен, полученный на этапе регистрации.
  1. Строка, полученная на предыдущем этапе.

### Пример работы алгоритма

> Пример реализации алгоритма

```php
<?php
$method = 'GET';
$slug = '/v1/statuses';
$params = null;
$datetime = '2020-06-04T10:45:35';
$body = null;
$token = 'token';
$secret = 'secret';
 
$params = $params ? urldecode($params) : '';
$body = hash('sha256', $body);
 
$step1 = implode(' ',
        [
            $method,
            $slug,
            $params,
            $datetime,
            $body
        ]
    );
 
$step2 = hash('sha256', $step1);
$step3 = hash_hmac('sha256', $step2, $secret);
$step4 = sprintf(
        '%s, %s, %s, %s',
        'HMAC-SHA256',
        $datetime,
        $token,
        $step3
    );
 
echo sprintf(
    "1.a. %s\n1.b. %s\n1.c. %s\n1.d. %s\n1.e. %s\n1. %s\n2. %s\n3. %s\n4. %s\n",
    $method, $slug, $params, $datetime, $body, $step1,
    $step2, $step3, $step4
);
```

Пусть необходимо сформировать подпись запроса для получения списка статусов заказов:

1. Запрос GET /v1/statuses
1. Запрос выполняется в 2020-06-04 10:45:35
1. Токен: token
1. Секретный код: secret

Для такого запроса подпись будет сформирована следующим образом:

1. Итоговая строка: ```GET /v1/statuses  2020-06-04T10:45:35 e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855```
  1. Метод: ```GET```
  1. Slug: ```/v1/statuses```
  1. URL-кодированная строка запроса: отсутствует, поэтому берётся пустая строка
  1. Дата и время: ```2020-06-04T10:45:35```
  1. Hash-сумма от тела запроса (отсутствует, поэтому считаем hash от пустой строки): ```e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855```
1. Hash-сумма от строки на шаге 1: ```83783d03eaf62acaead5f7f43e031dce9a176401da25385f29e9f1817c8cf6ba```
1. Hash-сумма от строки на шаге 2 с токеном в качестве ключа: ```07774802d4131659c75563aac4cfcb05bd03e6e483274427ab157f50e88d1d37```
1. Подпись запроса: ```HMAC-SHA256, 2020-06-04T10:45:35, token, 07774802d4131659c75563aac4cfcb05bd03e6e483274427ab157f50e88d1d37```

# Описание предметной области

## Описание процесса

Чтобы отправить заказ необходимо:

1. **Создать склад и магазин.** Отправка заказов Клиентом через Сервис возможна только после создания склада и магазина. Этот этап является обязательным, выполняется однократно из ЛК, и без него невозможно завершить регистрацию в Сервисе. Важно учитывать, что наименование магазина, указанное при его создании или в процессе редактирования, будет использовано Сервисом или СД в печатных формах (ярлыках и/или АПП).
1. **Создать заказ.** Клиенту для отправки товаров покупателю в Сервисе следует создать заказ. Перед созданием заказа рекомендуем рассчитать возможные варианты доставки, её стоимость и контрольный срок. В случае, если что-то пошло не так, заказ можно отредактировать или удалить. В любой момент времени можно получить текущее состояние заказа или историю изменения его статусов.
1. **Распечатать ярлык.** Для каждого заказа службой доставки формируется ярлык, который можно скачать.
1. **Создать партию**, даже если в ней будет всего 1 заказ. Группа заказов со схожими свойствами (отправитель и служба доставки) должна быть объединена в партию. В некоторых случаях может возникнуть необходимость обновить партию, добавив или удалив из неё заказы.
1. **Распечатать АПП.** Партия подтверждается автоматически сразу после создания или обновления, т.е. после любого из этих действий Сервис позволяет скачать АПП, т.к. при подтверждении партии формируется АПП отправления.

Только выполнение всех 4 действий гарантирует отправку заказа покупателю.
В описываемом процессе задействованы и некоторые другие сущности, не перечисленные выше. Большей их частью Клиент может управлять самостоятельно посредством API или через ЛК. Описание каждой из значимых сущностей будет приведено далее в контексте конкретных сценариев взаимодействия с Сервисом.

## Заказ

### Определение

Заказ - оформленный покупателем у Клиента заказ, передаваемый Клиентом в Сервис для отправки покупателю. Характеризуется набором атрибутов, среди которых:

1. Информация о магазине и складе Клиента:
1. Список магазинов Клиента можно получить, вызвав GET /v1/shops в API.
1. Список складов Клиента можно получить, вызвав GET /v1/warehouses в API.
1. СД, которой заказ будет доставлен покупателю. Список СД, подключенных клиентом, можно получить, вызвав метод GET /v1/deliveries в API.
1. ВГХ заказа.
1. Стоимостные характеристики.
1. Покупатель, включая его основные характеристики (ФИО, контакты для связи, адрес).
1. Список товарных позиций.
1. Оффер, по которому заказ будет отправлен получателю.
1. Прочее.

В зависимости от выполняемого действия Сервис и Клиент могут обмениваться разным набором характеристик заказа.

### Список действий с заказом

#### Создание заказа

<aside class="notice">
Для создания заказа необходимо вызвать метод POST /v1/orders в API, передав при этом информацию о заказе.
</aside>

Важно учитывать следующие особенности:

1. Оффер, по которому будет отправлен заказ:
  1. Определяется службой доставки и идентификатором тарифа в ней.
  1. Некоторые СД требуют указывать тариф, а некоторые - нет. Поэтому в общем случае мы рекомендуем указывать при создании заказа идентификатор тарифа от СД.
1. При создании заказа Клиент должен указать СД, выбранную для доставки заказа.
1. При создании заказа Клиент должен указать номер создаваемого заказа, присвоенный ему в информационной системе Клиента. Указанный номер заказа:
  1. Должен быть уникальным в пределах одного магазина Клиента. В случае, если Клиент попытается создать заказ с повторяющимся номером, Сервис не создаст новый заказ, а вернёт информацию о заказе, который был создан ранее.
  1. Может использоваться, например, в следующих ситуациях:
      1. Для устранения инцидентов, которые могут возникнуть в ходе интеграционного взаимодействия.
      1. Для печати ярлыков в ситуации, когда Клиент договорился с СД работать по своим номерам заказов.
1. В зависимости от выбранного типа доставки (courier, pickup, post) при создании заказа может потребоваться заполнение различных атрибутов:
  1. Тип «courier» означает курьерскую доставку. При указании типа доставки courier следует заполнить адрес в разделе о покупателе.
  1. Тип «pickup» означает доставку до ПВЗ. При указании типа доставки pickup адрес заполнять не нужно. Вместо него обязательно следует указать код ПВЗ. У Клиента есть 2 способа узнать код ПВЗ:
      1. Разместить на сайте своего ИМ виджет СД с выбором ПВЗ и получать информацию о коде ПВЗ из виджета.
      1. Получить список ПВЗ из Сервиса, вызвав метод GET /v1/pickuppoints в API, отфильтровать их по СД и выбрать из них тот, в который следует доставить заказ.
  1. Тип «post» означает доставку Почтой России. Важно учитывать, что этот тип доставки может быть указан тогда и только тогда, когда в качестве СД для доставки заказа выбрана Почта России. Т.е. если выбрать для отправки заказа другую СД, но указать тип доставки «post», то Сервис ответит ошибкой и не создаст заказ.
1. При создании заказа Клиент должен указать стоимостные характеристики, в числе которых:
  1. Стоимость доставки заказа. Эта стоимость Сервисом не используется, но является обязательной к заполнению, потому что большая часть СД требует заполнения этого поля.
  1. Предоплаченная часть заказа.
  1. Оценочная стоимость заказа, она же - объявленная ценность.
  1. Сумма, которую необходимо взять с покупателя перед выдачей заказа. Не может превышать объявленную ценность.
1. Номер заказа в системе складского оператора. В общем случае не требуется, но в некоторых ситуациях его заполнение обязательно. Если этот номер используется в вашем логистическом процессе, просто начните его передавать.
1. При осуществлении доставки Клиенту могут потребоваться дополнительные услуги (примерка, подъём груза, наложенный платёж и др.), которые он будет ожидать получить от СД. В этом случае клиент самостоятельно должен перечислить коды услуг. Сервис не ограничивает Клиента в перечислении. Такие услуги в API называются «сервисами», а их полный список можно получить, вызвав метод GET /services в API. 
1. При указании адреса покупателя Клиент может заполнить множество различных атрибутов, среди которых: код адреса в ФИАС, код адреса в КЛАДР, адрес одной строкой или адрес с разбивкой по нескольким полям (город, улица, дом и т.д.). Клиенту не следует заполнять каждое из этих полей, а нужно заполнить только одно из сочетаний:
  1. Почтовый индекс и адрес одной строкой в разбивке по атрибутам.
  1. Код ФИАС и адрес одной в разбивке по атрибутам.
  1. Код КЛАДР и адрес одной в разбивке по атрибутам.
  1. Адрес одной строкой.
1. Если Клиент заполнит несколько сочетаний адреса покупателя (например, почтовый индекс, код ФИАС и адрес одной строкой), то Сервис не сможет гарантировать.корректную передачу адреса в СД. В связи с этим мы настоятельно рекомендуем:
  1. Всегда явно указывать адрес отправителя.
  1. Не смешивать классификации адресов.
1. Для заказов, отправляемых Почтой России, необходимо указывать почтовый индекс. Если индекс не будет передан, то Сервис попытается узнать его по прочим переданным данным. Если этого не удастся сделать, то заказ не будет создан. По этой причине мы рекомендуем явно передавать почтовый индекс в тех случаях, когда требуется отправить заказ Почтой России.
1. ФИО покупателя. Причём Сервису достаточно знать только фамилию и имя. Обратите внимание на то, что при создании заказа составляющие ФИО передаются в отдельных полях. При этом технически возможна передача ФИО в одном поле, но в этом случае Сервис будет полагаться на службу верификации данных, которая разбивает строку на составляющие с определённой (не равной 100%) точностью. В связи с этим мы настоятельно рекомендуем указывать фамилию и имя в предусмотренных для этого полях запроса на создание заказа.
1. Кроме адреса, куда доставляется заказ, иногда может потребоваться узнать адрес, откуда он отправляется. Эта информация определяется по складу. Если у Клиента открывается новая локация отправления, то ему следует создать новый склад, после чего начать его указывать в заказах, которые отправляются из новой локации.
1. В заказе может быть перечислено несколько товарных позиций, причём:
  1. Для каждой из них может быть указан свой код ставки НДС. Полный список доступных для указания кодов ставки НДС можно получить, вызвав метод GET /v1/vats в API.
  1. Если не передать код ставки НДС, то Сервис принудительно подставит значение «НДС не облагается».
1. Сервис поддерживает возможность создания многоместного заказа, т.е. заказа, который по каким-то причинам не поместился в одной упаковке, но при этом должен быть доставлен покупателю единовременно. При этом важно учитывать, что:
  1. Не все СД поддерживают возможность отправки многоместных заказов. Прежде чем создавать такой заказ убедитесь, что СД может обеспечить такую возможность.
  1. В одном месте может быть перечислено несколько товарных позиций.
  1. Одна товарная позиция может быть размещена только в одном месте.
  1. Сервис не производит никаких валидаций, связанных с корректностью указания ВГХ в зависимости от добавленных в них товарных позиций и т.п.

#### Редактирование заказа

<aside class="notice">
Для редактирования заказа необходимо вызвать метод PUT /v1/orders/{id} в API, передав при этом информацию о заказе полностью, т.е. должны быть перечислены все поля - как изменённые, так и оставленные без изменений.
</aside>

В заказе посредством API можно отредактировать любое поле, но только до момента добавления заказа в партию. После редактирования в ЛК Сервиса Клиент будет видеть заказ с отредактированными значениями полей, равно как и при запросе информации о заказе через API. Однако это не означает, что вся эта информация будет отражена в СД. Эта особенность вызвана тем, что не все СД позволяют редактировать заказ, а те, которые позволяют, имеют некоторые ограничения, которые в настоящий момент не валидируются API Сервиса. По этой причине и во избежание возникновения каких-либо проблем настоятельно рекомендуем не редактировать заказ, а удалять его и создавать новый.

#### Удаление заказа

<aside class="notice">
Для удаления заказа необходимо вызвать метод DELETE /v1/orders/{id} в API.
</aside>

Заказ может быть удалён в любой момент, т.е. даже после добавления заказа в партию. После удаления заказ:
1. Перестаёт отображаться в ЛК.
1. Исключается из партии, если он уже был в неё добавлен.
1. Может продолжать отображаться в ЛК СД, т.к. не все СД позволяют удалять заказ, а те, которые позволяют, имеют некоторые ограничения, которые в настоящий момент не валидируются API Сервиса.

#### Получение информации о заказе

<aside class="notice">
Для получения информации о заказе необходимо вызвать метод GET /v1/orders/{id} в API.
</aside>

Несмотря на то, что Клиент при создании заказа передаёт в Сервис уникальный идентификатор заказа в собственной информационной системе, поиск заказов и получение информации по ним посредством обращения к API осуществляется по идентификатору, который был присвоен заказу Сервисом.

#### Получение истории статусов заказа

<aside class="notice">
Для получения истории статусов заказа необходимо вызвать метод GET /v1/orders/{id}/statuses в API.
</aside>

У каждой службы доставки имеется свой собственный набор статусов. Иногда они пересекаются по названиям и кодам, а иногда - нет. Поэтому в Сервисе используется собственная статусная модель. Сервис самостоятельно осуществляет сопоставление статусов заказа в различных СД со своей статусной моделью. Для получения списка возможных статусов заказа необходимо вызвать метод GET /v1/statuses в API.

#### Получение ярлыка заказа

<aside class="notice">
Для получения ярлыка заказа необходимо вызвать метод GET /v1/orders/{id}/labels в API. В ответе на обращение к сервису будет передан PDF-файл в кодировке base64.
</aside>

Ярлык - печатная форма СД, которая формируется для каждого заказа и обычно содержит штрихкод и прочую информацию, по которой СД в автоматическом режиме может осуществить обработку заказа: отправку в нужном направлении, доставку до нужного склада и т.п.

## Оффер

### Определение

Оффер - это один из тарифов, предлагаемых Клиенту службой доставки, по которому Клиент может отправить заказ покупателю. Список доступных клиенту тарифов и предлагаемых ему офферов:

1. Определяется не Клиентом, а СД, которые он подключил в Сервисе. Т.е. Клиент не может самостоятельно отредактировать список доступных ему тарифов, но может выбирать из предлагаемых офферов.
1. Зависит от ряда характеристик заказа, в т.ч. от:
  1. ВГХ.

  1. Типа доставки.

  1. Адресов отправления и назначения.

Сам оффер характеризуется рядом атрибутов, среди которых:
1. Стоимость доставки.
1. Сроки доставки (минимальный и максимальный).
1. Прочее.

Номера (идентификаторы) тарифов могут совпадать у различных служб доставки. При этом одна служба доставки может предложить несколько офферов на отправку одного заказа, которые могут отличаться по цене, срокам доставки и ряду других характеристик.
При указании стоимости тарифа не учитываются дополнительные услуги, т.е. в оффере всегда представлена базовая стоимость доставки заказа.

### Список действий с оффером

#### Расчёт стоимости заказа

См. Получение офферов.

#### Получение офферов

<aside class="notice">
Для получения списка офферов необходимо вызвать метод GET /v1/offers в API, передав при этом информацию о ВГХ и адресах отправителя и получателя.
</aside>

Важно учитывать следующие особенности:

1. При запросе списка офферов следует указать тип доставки (типы доставки подробно разбирались тут). В случае, если тип доставки не указан, то в ответе на запрос будут переданы все возможные офферы, но в них не будет указано признака, по которому можно было бы определить тип доставки. Поэтому во избежание возникновения каких-либо проблем  рекомендуем указывать тип доставки явно.
1. При указании адресов отправления и назначения Клиент может может заполнить множество различных атрибутов:
  1. Особенности их заполнения идентичны тем, которые были рассмотрены ранее при создании заказа.
  1. Клиент может совсем не передать информацию об адресе отправления. В этом случае Сервис в качестве города отправления подставит Москву.
  1. В связи с тем, что сказано в пунктах 2b и 2c настоящего списка, мы настоятельно рекомендуем:
      1. Всегда явно указывать адрес отправителя.
      1. Не смешивать классификации адресов.
1. Для заказов, отправляемых Почтой России, необходимо указывать почтовый индекс. Если индекс не будет передан, то Сервис попытается узнать его по прочим переданным данным. Если этого не удастся сделать, то в списке офферов не будет почтовых. По этой причине мы рекомендуем явно передавать почтовый индекс в тех случаях, когда требуется отправить заказ Почтой России.

## Тариф

См. Оффер.

# Описание API

## Стоимость доставки

### GET /v1/offers

## Заказы

### GET /v1/orders

### POST /v1/orders

### GET /v1/orders/{id}
